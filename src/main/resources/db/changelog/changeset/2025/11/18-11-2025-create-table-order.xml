<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="18-11-2025-create-table-order" author="rrishbuldin">

        <!-- clients -->
        <createTable ifNotExists="true" tableName="client">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="version" type="bigint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="phone" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(150)"/>
            <column name="address" type="TEXT"/>
            <column name="other_contacts" type="TEXT"/>
            <column name="user_id" type= "bigint">
                <constraints foreignKeyName="fk_client_user_id" nullable="true"
                             referencedTableName="user" referencedColumnNames="id"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="NOW()"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="NOW()"/>
        </createTable>

            <!-- ============================================================= -->
            <!-- 3. orders                                                     -->
            <!-- ============================================================= -->
                <createTable ifNotExists="true" tableName="orders">
                    <column name="id" type="BIGSERIAL">
                        <constraints primaryKey="true"/>
                    </column>

                    <column name="version" type="bigint" defaultValueNumeric="0">
                        <constraints nullable="false"/>
                    </column>

                    <!-- клиент -->
                    <column name="client_id" type="bigserial">
                        <constraints nullable="false"/>
                    </column>
                    <column name="client_name" type="VARCHAR(150)"/>
                    <column name="phone" type="VARCHAR(20)">
                        <constraints nullable="false"/>
                    </column>
                    <column name="address" type="TEXT"/>
                     <!-- Примечания к заказу -->
                    <column name="notes" type="TEXT"/>

                    <!-- номер заказа -->
                    <column name="order_number" type="VARCHAR(20)">
                        <constraints nullable="false" unique="true"/>
                    </column>

                    <!-- даты -->
                    <!-- Принят -->
                    <column name="received_at" type="TIMESTAMP" defaultValueComputed="NOW()"/>
                    <!-- обещано -->
                    <column name="promised_at" type="TIMESTAMP"/>
                    <!-- Готов -->
                    <column name="completed_at" type="TIMESTAMP"/>

                    <!-- статус и количество -->
                    <column name="status" type="VARCHAR(20)" defaultValue="new"/>
                    <!-- Количество ковров -->
                    <column name="items_count" type="INTEGER" defaultValueNumeric="1"/>
                    <column name="total_area_m2" type="NUMERIC(8,2)"/>

                    <column name="total_price" type="NUMERIC(10,2)">
                    </column>

                    <!-- скидки -->
                    <!-- Процент скидки -->
                    <column name="discount_percent" type="NUMERIC(5,2)" defaultValueNumeric="0"/>
                    <!-- Сумма скидки -->
                    <column name="discount_amount" type="NUMERIC(10,2)" defaultValueNumeric="0"/>
                    <!-- Сумма к оплате -->
                    <column name="final_price" type="NUMERIC(10,2)">
                        <constraints nullable="true"/>
                    </column>

                    <!-- оплата -->
                    <column name="payment_method" type="VARCHAR(20)"/>
                    <column name="payment_status" type="VARCHAR(20)" defaultValue="pending"/>

                    <!-- логистика -->
                    <!-- Нужно ли забирать -->
                    <column name="pickup_required" type="BOOLEAN" defaultValueBoolean="true"/>
                    <!-- Когда нужно забрать -->
                    <column name="pickup_scheduled_at" type="TIMESTAMP"/>
                    <!-- Нужна ли доставка -->
                    <column name="delivery_required" type="BOOLEAN" defaultValueBoolean="true"/>
                    <!-- Когда нужна доставка -->
                    <column name="delivery_scheduled_at" type="TIMESTAMP"/>

                    <!-- доп. поля -->
                    <column name="source" type="VARCHAR(30)"/>
                    <!-- теги пример: {"без кондиционера", "срочно"} -->
                    <column name="tags" type="TEXT[]"/>
                    <column name="photos_before" type="TEXT[]"/>
                    <column name="photos_after" type="TEXT[]"/>

                    <!-- системные -->
                    <column name="created_at" type="TIMESTAMP" defaultValueComputed="NOW()"/>
                    <column name="updated_at" type="TIMESTAMP" defaultValueComputed="NOW()"/>
                    <column name="deleted_at" type="TIMESTAMP"/>
                </createTable>
            <!-- ============================================================= -->
            <!-- 4. order_items                                                -->
            <!-- ============================================================= -->
                <createTable tableName="order_items">
                    <column name="id" type="BIGSERIAL">
                        <constraints primaryKey="true"/>
                    </column>
                    <!-- ссылка на заказ -->
                    <column name="order_id" type="BIGINT"/>
                    <!-- материал ковра -->
                    <column name="carpet_type" type="VARCHAR(50)"/>
                    <!-- длина -->
                    <column name="length_cm" type="INTEGER"/>
                    <!-- ширина -->
                    <column name="width_cm" type="INTEGER"/>

                    <!-- вычисляемая площадь -->
                    <column name="area_m2" type="NUMERIC(6,2)"/>
                    <!-- состояние до -->
                    <column name="condition_in" type="VARCHAR(30)"/>
                    <!-- состояние после -->
                    <column name="condition_out" type="VARCHAR(30)"/>
                    <!-- цена за квадрат -->
                    <column name="price_per_m2" type="NUMERIC(8,2)" defaultValueNumeric="250.00" />
                    <!-- цена за ковер -->
                    <column name="item_price" type="NUMERIC(10,2)"/>
                    <column name="notes" type="TEXT"/>
                </createTable>

            <!-- ============================================================= -->
            <!-- 5. Foreign keys                                               -->
            <!-- ============================================================= -->

                <addForeignKeyConstraint baseTableName="orders"
                                         baseColumnNames="client_id"
                                         constraintName="fk_orders_client_id"
                                         referencedTableName="client"
                                         referencedColumnNames="id"
                                         onDelete="CASCADE"/>

                <addForeignKeyConstraint baseTableName="order_items"
                                         baseColumnNames="order_id"
                                         constraintName="fk_order_items_order_id"
                                         referencedTableName="orders"
                                         referencedColumnNames="id"
                                         onDelete="CASCADE"/>

            <!-- ============================================================= -->
            <!-- 6. Indexes                                                    -->
            <!-- ============================================================= -->
                <createIndex tableName="orders" indexName="idx_orders_status">
                    <column name="status"/>
                </createIndex>

                <createIndex tableName="orders" indexName="idx_orders_client_id">
                    <column name="client_id"/>
                </createIndex>

                <createIndex tableName="orders" indexName="idx_orders_promised_at">
                    <column name="promised_at"/>
                </createIndex>

                <createIndex tableName="orders" indexName="idx_orders_order_number">
                    <column name="order_number"/>
                </createIndex>

                <createIndex tableName="order_items" indexName="idx_order_items_order_id">
                    <column name="order_id"/>
                </createIndex>
    </changeSet>
</databaseChangeLog>